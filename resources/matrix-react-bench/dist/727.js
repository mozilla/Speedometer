"use strict";(globalThis.webpackChunkmatrix_shell_bench=globalThis.webpackChunkmatrix_shell_bench||[]).push([[727],{66727:(e,t,a)=>{a.r(t),a.d(t,{default:()=>P});var s=a(35466),r=a(61762),n=a.n(r),i=a(19569),o=a(38027),l=a(3074),c=a.n(l),h=a(74879),u=a(81488),p=a(31888),m=a(67069),y=a(44121);function _(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}const d=0,k=5;class P extends s.PureComponent{constructor(e){super(e),_(this,"_collectRecoveryKeyNode",(e=>{this._recoveryKeyNode=e})),_(this,"_onCopyClick",(()=>{(0,m.Bc)(this._recoveryKeyNode)&&this.setState({copied:!0,phase:3})})),_(this,"_onDownloadClick",(()=>{const e=new Blob([this._keyBackupInfo.recovery_key],{type:"text/plain;charset=us-ascii"});n().saveAs(e,"security-key.txt"),this.setState({downloaded:!0,phase:3})})),_(this,"_createBackup",(async()=>{const{secureSecretStorage:e}=this.state;let t;this.setState({phase:4,error:null});try{e?await(0,u.zL)((async()=>{t=await o.p.get().prepareKeyBackupVersion(null,{secureSecretStorage:!0}),t=await o.p.get().createKeyBackupVersion(t)})):t=await o.p.get().createKeyBackupVersion(this._keyBackupInfo),await o.p.get().scheduleAllGroupSessionsForBackup(),this.setState({phase:k})}catch(e){console.error("Error creating key backup",e),t&&o.p.get().deleteKeyBackupVersion(t.version),this.setState({error:e})}})),_(this,"_onCancel",(()=>{this.props.onFinished(!1)})),_(this,"_onDone",(()=>{this.props.onFinished(!0)})),_(this,"_onOptOutClick",(()=>{this.setState({phase:6})})),_(this,"_onSetUpClick",(()=>{this.setState({phase:d})})),_(this,"_onSkipPassPhraseClick",(async()=>{this._keyBackupInfo=await o.p.get().prepareKeyBackupVersion(),this.setState({copied:!1,downloaded:!1,phase:2})})),_(this,"_onPassPhraseNextClick",(async e=>{if(e.preventDefault(),this._passphraseField.current){if(await this._passphraseField.current.validate({allowEmpty:!1}),!this._passphraseField.current.state.valid)return this._passphraseField.current.focus(),void this._passphraseField.current.validate({allowEmpty:!1,focused:!0});this.setState({phase:1})}})),_(this,"_onPassPhraseConfirmNextClick",(async e=>{e.preventDefault(),this.state.passPhrase===this.state.passPhraseConfirm&&(this._keyBackupInfo=await o.p.get().prepareKeyBackupVersion(this.state.passPhrase),this.setState({copied:!1,downloaded:!1,phase:2}))})),_(this,"_onSetAgainClick",(()=>{this.setState({passPhrase:"",passPhraseValid:!1,passPhraseConfirm:"",phase:d})})),_(this,"_onKeepItSafeBackClick",(()=>{this.setState({phase:2})})),_(this,"_onPassPhraseValidate",(e=>{this.setState({passPhraseValid:e.valid})})),_(this,"_onPassPhraseChange",(e=>{this.setState({passPhrase:e.target.value})})),_(this,"_onPassPhraseConfirmChange",(e=>{this.setState({passPhraseConfirm:e.target.value})})),this._recoveryKeyNode=null,this._keyBackupInfo=null,this.state={secureSecretStorage:null,phase:d,passPhrase:"",passPhraseValid:!1,passPhraseConfirm:"",copied:!1,downloaded:!1},this._passphraseField=(0,s.createRef)()}async componentDidMount(){const e=o.p.get(),t=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing");this.setState({secureSecretStorage:t}),t&&(this.setState({phase:4}),this._createBackup())}_renderPhasePassPhrase(){const e=i.Xr("views.elements.DialogButtons");return s.createElement("form",{onSubmit:this._onPassPhraseNextClick},s.createElement("p",null,(0,h._t)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>s.createElement("b",null,e)})),s.createElement("p",null,(0,h._t)("We'll store an encrypted copy of your keys on our server. Secure your backup with a Security Phrase.")),s.createElement("p",null,(0,h._t)("For maximum security, this should be different from your account password.")),s.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},s.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseContainer"},s.createElement(y.Z,{className:"mx_CreateKeyBackupDialog_passPhraseInput",onChange:this._onPassPhraseChange,minScore:4,value:this.state.passPhrase,onValidate:this._onPassPhraseValidate,fieldRef:this._passphraseField,autoFocus:!0,label:(0,h.I8)("Enter a Security Phrase"),labelEnterPassword:(0,h.I8)("Enter a Security Phrase"),labelStrongPassword:(0,h.I8)("Great! This Security Phrase looks strong enough."),labelAllowedButUnsafe:(0,h.I8)("Great! This Security Phrase looks strong enough.")}))),s.createElement(e,{primaryButton:(0,h._t)("Next"),onPrimaryButtonClick:this._onPassPhraseNextClick,hasCancel:!1,disabled:!this.state.passPhraseValid}),s.createElement("details",null,s.createElement("summary",null,(0,h._t)("Advanced")),s.createElement(p.Z,{kind:"primary",onClick:this._onSkipPassPhraseClick},(0,h._t)("Set up with a Security Key"))))}_renderPhasePassPhraseConfirm(){const e=i.Xr("elements.AccessibleButton");let t,a;this.state.passPhraseConfirm===this.state.passPhrase?(t=(0,h._t)("That matches!"),a=(0,h._t)("Use a different passphrase?")):this.state.passPhrase.startsWith(this.state.passPhraseConfirm)||(t=(0,h._t)("That doesn't match."),a=(0,h._t)("Go back to set it again."));let r=null;t&&(r=s.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseMatch"},s.createElement("div",null,t),s.createElement("div",null,s.createElement(e,{element:"span",className:"mx_linkButton",onClick:this._onSetAgainClick},a))));const n=i.Xr("views.elements.DialogButtons");return s.createElement("form",{onSubmit:this._onPassPhraseConfirmNextClick},s.createElement("p",null,(0,h._t)("Enter your Security Phrase a second time to confirm it.")),s.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},s.createElement("div",{className:"mx_CreateKeyBackupDialog_passPhraseContainer"},s.createElement("div",null,s.createElement("input",{type:"password",onChange:this._onPassPhraseConfirmChange,value:this.state.passPhraseConfirm,className:"mx_CreateKeyBackupDialog_passPhraseInput",placeholder:(0,h._t)("Repeat your Security Phrase..."),autoFocus:!0})),r)),s.createElement(n,{primaryButton:(0,h._t)("Next"),onPrimaryButtonClick:this._onPassPhraseConfirmNextClick,hasCancel:!1,disabled:this.state.passPhrase!==this.state.passPhraseConfirm}))}_renderPhaseShowKey(){return s.createElement("div",null,s.createElement("p",null,(0,h._t)("Your Security Key is a safety net - you can use it to restore access to your encrypted messages if you forget your Security Phrase.")),s.createElement("p",null,(0,h._t)("Keep a copy of it somewhere secure, like a password manager or even a safe.")),s.createElement("div",{className:"mx_CreateKeyBackupDialog_primaryContainer"},s.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyHeader"},(0,h._t)("Your Security Key")),s.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyContainer"},s.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKey"},s.createElement("code",{ref:this._collectRecoveryKeyNode},this._keyBackupInfo.recovery_key)),s.createElement("div",{className:"mx_CreateKeyBackupDialog_recoveryKeyButtons"},s.createElement("button",{className:"mx_Dialog_primary",onClick:this._onCopyClick},(0,h._t)("Copy")),s.createElement("button",{className:"mx_Dialog_primary",onClick:this._onDownloadClick},(0,h._t)("Download"))))))}_renderPhaseKeepItSafe(){let e;this.state.copied?e=(0,h._t)("Your Security Key has been <b>copied to your clipboard</b>, paste it to:",{},{b:e=>s.createElement("b",null,e)}):this.state.downloaded&&(e=(0,h._t)("Your Security Key is in your <b>Downloads</b> folder.",{},{b:e=>s.createElement("b",null,e)}));const t=i.Xr("views.elements.DialogButtons");return s.createElement("div",null,e,s.createElement("ul",null,s.createElement("li",null,(0,h._t)("<b>Print it</b> and store it somewhere safe",{},{b:e=>s.createElement("b",null,e)})),s.createElement("li",null,(0,h._t)("<b>Save it</b> on a USB key or backup drive",{},{b:e=>s.createElement("b",null,e)})),s.createElement("li",null,(0,h._t)("<b>Copy it</b> to your personal cloud storage",{},{b:e=>s.createElement("b",null,e)}))),s.createElement(t,{primaryButton:(0,h._t)("Continue"),onPrimaryButtonClick:this._createBackup,hasCancel:!1},s.createElement("button",{onClick:this._onKeepItSafeBackClick},(0,h._t)("Back"))))}_renderBusyPhase(e){const t=i.Xr("views.elements.Spinner");return s.createElement("div",null,s.createElement(t,null))}_renderPhaseDone(){const e=i.Xr("views.elements.DialogButtons");return s.createElement("div",null,s.createElement("p",null,(0,h._t)("Your keys are being backed up (the first backup could take a few minutes).")),s.createElement(e,{primaryButton:(0,h._t)("OK"),onPrimaryButtonClick:this._onDone,hasCancel:!1}))}_renderPhaseOptOutConfirm(){const e=i.Xr("views.elements.DialogButtons");return s.createElement("div",null,(0,h._t)("Without setting up Secure Message Recovery, you won't be able to restore your encrypted message history if you log out or use another session."),s.createElement(e,{primaryButton:(0,h._t)("Set up Secure Message Recovery"),onPrimaryButtonClick:this._onSetUpClick,hasCancel:!1},s.createElement("button",{onClick:this._onCancel},"I understand, continue without")))}_titleForPhase(e){switch(e){case d:return(0,h._t)("Secure your backup with a Security Phrase");case 1:return(0,h._t)("Confirm your Security Phrase");case 6:return(0,h._t)("Warning!");case 2:case 3:return(0,h._t)("Make a copy of your Security Key");case 4:return(0,h._t)("Starting backup...");case k:return(0,h._t)("Success!");default:return(0,h._t)("Create key backup")}}render(){const e=i.Xr("views.dialogs.BaseDialog");let t;if(this.state.error){const e=i.Xr("views.elements.DialogButtons");t=s.createElement("div",null,s.createElement("p",null,(0,h._t)("Unable to create key backup")),s.createElement("div",{className:"mx_Dialog_buttons"},s.createElement(e,{primaryButton:(0,h._t)("Retry"),onPrimaryButtonClick:this._createBackup,hasCancel:!0,onCancel:this._onCancel})))}else switch(this.state.phase){case d:t=this._renderPhasePassPhrase();break;case 1:t=this._renderPhasePassPhraseConfirm();break;case 2:t=this._renderPhaseShowKey();break;case 3:t=this._renderPhaseKeepItSafe();break;case 4:t=this._renderBusyPhase();break;case k:t=this._renderPhaseDone();break;case 6:t=this._renderPhaseOptOutConfirm()}return s.createElement(e,{className:"mx_CreateKeyBackupDialog",onFinished:this.props.onFinished,title:this._titleForPhase(this.state.phase),hasCancel:[d,k].includes(this.state.phase)},s.createElement("div",null,t))}}_(P,"propTypes",{onFinished:c().func.isRequired})}}]);
//# sourceMappingURL=727.js.map